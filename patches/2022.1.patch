From d2767f42e953d59d24b6d7bc6d5f84f58deb33a6 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Benjamin=20Menk=C3=BCc?= <benjamin@menkuec.de>
Date: Fri, 22 Jul 2022 16:31:31 +0200
Subject: [PATCH 1/6] fix: add all dependency to install target in Makefile

---
 ...0001-Makefile-fix_install_target_in_makefile.patch | 11 +++++++++++
 1 file changed, 11 insertions(+)
 create mode 100644 package/libaio/0001-Makefile-fix_install_target_in_makefile.patch

diff --git a/package/libaio/0001-Makefile-fix_install_target_in_makefile.patch b/package/libaio/0001-Makefile-fix_install_target_in_makefile.patch
new file mode 100644
index 0000000000..3e2317c4ce
--- /dev/null
+++ b/package/libaio/0001-Makefile-fix_install_target_in_makefile.patch
@@ -0,0 +1,11 @@
+--- Makefile.orig	2022-07-22 16:18:03.697464100 +0200
++++ Makefile	2022-07-22 16:15:54.786296000 +0200
+@@ -13,7 +13,7 @@
+ all:
+ 	@$(MAKE) -C src
+ 
+-install:
++install: all
+ 	@$(MAKE) -C src install prefix=$(DESTDIR)$(prefix) includedir=$(DESTDIR)$(includedir) libdir=$(DESTDIR)$(libdir)
+         $(info $(MAKE) -C src install prefix=$(DESTDIR)$(prefix) includedir=$(DESTDIR)$(includedir) libdir=$(DESTDIR)$(libdir))
+ 

From a7e9884bb6b46933611cc158a5d8c5d1e87b1537 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Benjamin=20Menk=C3=BCc?= <benjamin@menkuec.de>
Date: Fri, 22 Jul 2022 16:36:11 +0200
Subject: [PATCH 2/6] fix: remove unneeded patch. It gives an error during
 compilation.

---
 ...rs-setters-cannot-be-marked-readonly.patch | 32 -------------------
 1 file changed, 32 deletions(-)
 delete mode 100644 package/libiio/0001-C-public-fields-with-getters-setters-cannot-be-marked-readonly.patch

diff --git a/package/libiio/0001-C-public-fields-with-getters-setters-cannot-be-marked-readonly.patch b/package/libiio/0001-C-public-fields-with-getters-setters-cannot-be-marked-readonly.patch
deleted file mode 100644
index a665d48363..0000000000
--- a/package/libiio/0001-C-public-fields-with-getters-setters-cannot-be-marked-readonly.patch
+++ /dev/null
@@ -1,32 +0,0 @@
-From 85bf9cd32138539252ed01c355cf766612cf47c9 Mon Sep 17 00:00:00 2001
-From: Paul Cercueil <paul@crapouillou.net>
-Date: Thu, 2 Sep 2021 11:04:21 +0100
-Subject: [PATCH] C#: public fields with getters/setters cannot be marked
- readonly
-
-MSVC would fail with the following error:
-error CS0106: The modifier 'readonly' is not valid for this item
-
-Reported-by: Raluca Chis <raluca.chis@analog.com>
-Signed-off-by: Paul Cercueil <paul@crapouillou.net>
-
-[Retrieved from:
-https://github.com/analogdevicesinc/libiio/commit/85bf9cd32138539252ed01c355cf766612cf47c9]
-Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
----
- bindings/csharp/Device.cs | 2 +-
- 1 file changed, 1 insertion(+), 1 deletion(-)
-
-diff --git a/bindings/csharp/Device.cs b/bindings/csharp/Device.cs
-index 96214243f..6c8c8f4f3 100644
---- a/bindings/csharp/Device.cs
-+++ b/bindings/csharp/Device.cs
-@@ -208,7 +208,7 @@ public override void write(string str)
-         public readonly string name;
- 
-         /// <summary>The label of this device.</summary>
--        public readonly string label { get; private set; }
-+        public string label { get; private set; }
- 
-         /// <summary>A <c>list</c> of all the attributes that this device has.</summary>
-         public readonly List<Attr> attrs;

From 02aa0e9c7e37ec04ba925598ef895d3b86146e64 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Benjamin=20Menk=C3=BCc?= <benjamin@menkuec.de>
Date: Fri, 22 Jul 2022 16:38:16 +0200
Subject: [PATCH 3/6] add BR2_TOOLCHAIN_EXTERNAL_INET_RPC=n to default config
 for PlutoSDR to make it compatible with Vitis 2022.1

---
 configs/zynq_pluto_defconfig | 1 +
 1 file changed, 1 insertion(+)

diff --git a/configs/zynq_pluto_defconfig b/configs/zynq_pluto_defconfig
index 7375c29a74..f0e246d3bd 100644
--- a/configs/zynq_pluto_defconfig
+++ b/configs/zynq_pluto_defconfig
@@ -10,6 +10,7 @@ BR2_TOOLCHAIN_EXTERNAL_GCC_8=y
 BR2_TOOLCHAIN_EXTERNAL_HEADERS_4_14=y
 BR2_TOOLCHAIN_EXTERNAL_CUSTOM_GLIBC=y
 BR2_TOOLCHAIN_EXTERNAL_CXX=y
+BR2_TOOLCHAIN_EXTERNAL_INET_RPC=n
 BR2_TARGET_GENERIC_HOSTNAME="pluto"
 BR2_TARGET_GENERIC_ISSUE="Welcome to Pluto"
 BR2_ROOTFS_DEVICE_CREATION_DYNAMIC_MDEV=y

From b74c829e38bd332914f0f766ac22332c13460441 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Benjamin=20Menk=C3=BCc?= <benjamin@menkuec.de>
Date: Fri, 22 Jul 2022 18:12:37 +0200
Subject: [PATCH 4/6] git fix name in patch

---
 .../0001-Makefile-fix_install_target_in_makefile.patch      | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/package/libaio/0001-Makefile-fix_install_target_in_makefile.patch b/package/libaio/0001-Makefile-fix_install_target_in_makefile.patch
index 3e2317c4ce..65082974ba 100644
--- a/package/libaio/0001-Makefile-fix_install_target_in_makefile.patch
+++ b/package/libaio/0001-Makefile-fix_install_target_in_makefile.patch
@@ -1,5 +1,5 @@
---- Makefile.orig	2022-07-22 16:18:03.697464100 +0200
-+++ Makefile	2022-07-22 16:15:54.786296000 +0200
+--- libaio-0.3.112/Makefile.orig	2022-07-22 16:52:50.103332100 +0200
++++ libaio-0.3.112/Makefile	2022-07-22 16:59:08.555076300 +0200
 @@ -13,7 +13,7 @@
  all:
  	@$(MAKE) -C src
@@ -7,5 +7,5 @@
 -install:
 +install: all
  	@$(MAKE) -C src install prefix=$(DESTDIR)$(prefix) includedir=$(DESTDIR)$(includedir) libdir=$(DESTDIR)$(libdir)
-         $(info $(MAKE) -C src install prefix=$(DESTDIR)$(prefix) includedir=$(DESTDIR)$(includedir) libdir=$(DESTDIR)$(libdir))
  
+ check:

From 7d8baca3dbbb649545111f16a5c6f84cd2779610 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Benjamin=20Menk=C3=BCc?= <benjamin@menkuec.de>
Date: Fri, 22 Jul 2022 22:01:20 +0200
Subject: [PATCH 5/6] fix ad936x_ref_cal hash

---
 package/ad936x_ref_cal/ad936x_ref_cal.hash | 2 +-
 package/ad936x_ref_cal/ad936x_ref_cal.mk   | 3 +--
 2 files changed, 2 insertions(+), 3 deletions(-)

diff --git a/package/ad936x_ref_cal/ad936x_ref_cal.hash b/package/ad936x_ref_cal/ad936x_ref_cal.hash
index 24eb7fb88b..1cd44fff8e 100644
--- a/package/ad936x_ref_cal/ad936x_ref_cal.hash
+++ b/package/ad936x_ref_cal/ad936x_ref_cal.hash
@@ -1,5 +1,5 @@
 # Locally computed
-sha256 26aedd8021fa939ab2f53e55904d869207265242fef7ad86aa4673e219b7cbef ad936x_ref_cal-01747db5cd60ff64115a73ac1f3bb97911f5c58e-br1.tar.gz
+sha256 f62c26dcb84cbe6417f9d4359644e81bc75ddf929ab7e13d6d7711c3659c0f83 ad936x_ref_cal-01747db5cd60ff64115a73ac1f3bb97911f5c58e.tar.gz
 
 # License files (locally computed as well)
 sha256 8177f97513213526df2cf6184d8ff986c675afb514d4e68a404010521b880643 LICENSE
diff --git a/package/ad936x_ref_cal/ad936x_ref_cal.mk b/package/ad936x_ref_cal/ad936x_ref_cal.mk
index 32e38fafaf..2e5a0d3596 100644
--- a/package/ad936x_ref_cal/ad936x_ref_cal.mk
+++ b/package/ad936x_ref_cal/ad936x_ref_cal.mk
@@ -6,8 +6,7 @@
 
 
 AD936X_REF_CAL_VERSION = 01747db5cd60ff64115a73ac1f3bb97911f5c58e
-AD936X_REF_CAL_SITE = https://github.com/analogdevicesinc/plutosdr_scripts.git
-AD936X_REF_CAL_SITE_METHOD = git
+AD936X_REF_CAL_SITE = $(call github,analogdevicesinc,plutosdr_scripts,$(AD936X_REF_CAL_VERSION))
 AD936X_REF_CAL_LICENSE = GPLv2
 AD936X_REF_CAL_LICENSE_FILES = LICENSE
 AD936X_REF_CAL_DEPENDENCIES = libiio fftw-double

From b3aa1821e2948b7a3afde2b573619c837e7d309c Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Benjamin=20Menk=C3=BCc?= <benjamin@menkuec.de>
Date: Fri, 22 Jul 2022 22:42:11 +0200
Subject: [PATCH 6/6] Add a patch for Vitis 2022.1 that replaces relative paths
 with absolute paths. This is necessary for building with buildroot. Every
 user has to apply this patch manually.

---
 Vitis2022.1.patch | 54 +++++++++++++++++++++++++++++++++++++++++++++++
 1 file changed, 54 insertions(+)
 create mode 100644 Vitis2022.1.patch

diff --git a/Vitis2022.1.patch b/Vitis2022.1.patch
new file mode 100644
index 0000000000..c30a91bd2f
--- /dev/null
+++ b/Vitis2022.1.patch
@@ -0,0 +1,54 @@
+diff -ruN bin_orig/arm-linux-gnueabihf-ar bin/arm-linux-gnueabihf-ar
+--- bin_orig/arm-linux-gnueabihf-ar	2022-07-22 22:20:20.680995700 +0200
++++ bin/arm-linux-gnueabihf-ar	2022-07-19 22:18:43.510699300 +0200
+@@ -1,3 +1,3 @@
+ #!/bin/bash
+-CC="`dirname $0`/../x86_64-petalinux-linux/usr/bin/arm-xilinx-linux-gnueabi/arm-xilinx-linux-gnueabi-ar"
++CC="/tools/Xilinx/Vitis/2022.1/gnu/aarch32/lin/gcc-arm-linux-gnueabi/x86_64-petalinux-linux/usr/bin/arm-xilinx-linux-gnueabi/arm-xilinx-linux-gnueabi-ar"
+ $CC "$@" 
+diff -ruN bin_orig/arm-linux-gnueabihf-gcc bin/arm-linux-gnueabihf-gcc
+--- bin_orig/arm-linux-gnueabihf-gcc	2022-07-22 22:20:02.570995700 +0200
++++ bin/arm-linux-gnueabihf-gcc	2022-07-22 11:41:43.360995700 +0200
+@@ -1,6 +1,6 @@
+ #!/bin/bash
+-CC="`dirname $0`/../x86*/usr/bin/arm-xilinx-linux-gnueabi/arm-xilinx-linux-gnueabi-gcc"
+-LIBC="`dirname $0`/../cortexa9t2hf-neon-xilinx-linux-gnueabi"
++CC="/tools/Xilinx/Vitis/2022.1/gnu/aarch32/lin/gcc-arm-linux-gnueabi/x86*/usr/bin/arm-xilinx-linux-gnueabi/arm-xilinx-linux-gnueabi-gcc"
++LIBC="/tools/Xilinx/Vitis/2022.1/gnu/aarch32/lin/gcc-arm-linux-gnueabi/cortexa9t2hf-neon-xilinx-linux-gnueabi"
+ FLAGS=" -mfpu=neon -mfloat-abi=hard"
+ for i in "$@"
+ do
+diff -ruN bin_orig/arm-linux-gnueabihf-gcc-ar bin/arm-linux-gnueabihf-gcc-ar
+--- bin_orig/arm-linux-gnueabihf-gcc-ar	2022-07-22 22:21:46.420995700 +0200
++++ bin/arm-linux-gnueabihf-gcc-ar	2022-07-19 22:28:16.540699300 +0200
+@@ -1,3 +1,3 @@
+ #!/bin/bash
+-CC=`dirname $0`/../x86*/usr/bin/arm-xilinx-linux-gnueabi/arm-xilinx-linux-gnueabi-gcc-ar
++CC=/tools/Xilinx/Vitis/2022.1/gnu/aarch32/lin/gcc-arm-linux-gnueabi/x86*/usr/bin/arm-xilinx-linux-gnueabi/arm-xilinx-linux-gnueabi-gcc-ar
+ $CC $@
+diff -ruN bin_orig/arm-linux-gnueabihf-gcc-ranlib bin/arm-linux-gnueabihf-gcc-ranlib
+--- bin_orig/arm-linux-gnueabihf-gcc-ranlib	2022-07-22 22:22:04.440995700 +0200
++++ bin/arm-linux-gnueabihf-gcc-ranlib	2022-07-19 22:32:42.940699300 +0200
+@@ -1,3 +1,3 @@
+ #!/bin/bash
+-CC=`dirname $0`/../x86*/usr/bin/arm-xilinx-linux-gnueabi/arm-xilinx-linux-gnueabi-gcc-ranlib
++CC=/tools/Xilinx/Vitis/2022.1/gnu/aarch32/lin/gcc-arm-linux-gnueabi/x86*/usr/bin/arm-xilinx-linux-gnueabi/arm-xilinx-linux-gnueabi-gcc-ranlib
+ $CC $@
+diff -ruN bin_orig/arm-linux-gnueabihf-ld bin/arm-linux-gnueabihf-ld
+--- bin_orig/arm-linux-gnueabihf-ld	2022-07-22 22:20:43.130995700 +0200
++++ bin/arm-linux-gnueabihf-ld	2022-07-22 09:47:42.810995700 +0200
+@@ -1,4 +1,4 @@
+ #!/bin/bash
+-CC="`dirname $0`/../x86*/usr/bin/arm-xilinx-linux-gnueabi/arm-xilinx-linux-gnueabi-ld"
+-LIBC="`dirname $0`/../cortexa9t2hf-neon-xilinx-linux-gnueabi"
++CC="/tools/Xilinx/Vitis/2022.1/gnu/aarch32/lin/gcc-arm-linux-gnueabi/x86*/usr/bin/arm-xilinx-linux-gnueabi/arm-xilinx-linux-gnueabi-ld"
++LIBC="/tools/Xilinx/Vitis/2022.1/gnu/aarch32/lin/gcc-arm-linux-gnueabi/cortexa9t2hf-neon-xilinx-linux-gnueabi"
+ $CC --sysroot=$LIBC "$@"
+diff -ruN bin_orig/arm-linux-gnueabihf-ranlib bin/arm-linux-gnueabihf-ranlib
+--- bin_orig/arm-linux-gnueabihf-ranlib	2022-07-22 22:21:13.560995700 +0200
++++ bin/arm-linux-gnueabihf-ranlib	2022-07-22 18:15:26.770995700 +0200
+@@ -1,3 +1,3 @@
+ #!/bin/bash
+-CC=`dirname $0`/../x86*/usr/bin/arm-xilinx-linux-gnueabi/arm-xilinx-linux-gnueabi-ranlib
++CC=/tools/Xilinx/Vitis/2022.1/gnu/aarch32/lin/gcc-arm-linux-gnueabi/x86*/usr/bin/arm-xilinx-linux-gnueabi/arm-xilinx-linux-gnueabi-ranlib
+ $CC $@
